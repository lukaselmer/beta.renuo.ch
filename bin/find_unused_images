#!/bin/zsh

source ~/.zshrc

echo 'Check images of existency'
"$@" &
invalid=false
files_checked=1
find src \( -name *.jpg -or -name *.jpeg -or -name *.png -or -name *.gif \) -print0 | while read -d  $'\0' file
do
  files_checked=$(($files_checked+1))
  if [[ $file =~ ^src\/files\/ico\/ ]]; then
    continue;
  fi
  file_name=$(echo "$file" | sed 's/.*\///')
  printf '\033[32m.\033[0m' > /dev/tty
  grep -i -r  --include \*.html.eco --include \*.html --include \*.css --include \*.scss -q "$file_name" src
  if [ ! $? -eq 0 ]; then
    grep -i -r  --include \*.html --include \*.css -q "$file_name" out
    if [ ! $? -eq 0 ]; then
      echo -e "\033[31m\n$file has never been used. Please delete it if not used and try again\033[0m"
      invalid=true
    fi
  fi
done
printf '\n' > /dev/tty
echo "$files_checked Files checked"
if [ "$invalid" = true ]; then
  echo "$invalid"
  echo -e "\033[31m\nCommit Aborted\033[0m"
  exit 1
fi
